<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Http\File;
use Illuminate\Support\Facades\Input;

use App\LogRequest;

class OctaveController extends Controller
{

    private $logCommand="";


    public function index()
    {
       // $response = shell_exec("octave --no-gui --quiet ../../kyvadlo.txt {r}");

        $command = Storage::get('octave/gulicka.txt');

        $response = ltrim(shell_exec('octave --no-gui --quiet --eval "pkg load control;'. $command .'"'));

        return response($response,200);
    }

    public function execute_octave_command(Request $request)
    {
       $data = $request->json()->all();

       $command = $data["command"];
       $logCommand = $command;
       $log = new LogRequest($logCommand, "OK");
       $log->save();

       $result = ltrim(shell_exec('octave --no-gui --quiet --eval "'. $command .'"'));

       $response = array(
           "result" => $result
       );

       return json_encode($response);
    }


    public function get_ball_data(Request $request)
    {

        try {

        $query = ($request->query());

        $r = $query["r"];
        $startPosition = $query["startPosition"];
        $startSpeed = $query["startSpeed"];

        $command = $this->get_ball_script($r,$startPosition,$startSpeed);

        $response = trim(shell_exec('octave --no-gui --quiet --eval "pkg load control;'. $command .'"'));


        $parsed = explode("ans =",$response);

        $position = explode('  ',$parsed[1]);
        $alfa = explode('  ',$parsed[2]);

	$position = array_map('trim', $position);
	$alfa = array_map('trim',$alfa);

        $return = array(
            "position" => $position,
            "angle" => $alfa
        );

        return json_encode($return);
        } catch (\Throwable $th) {
//throw $th;
  	 return response("Error",500);
        }


    }



    private function get_ball_script($r,$startPosition,$startSpeed)
    {
        return "
                m = 0.111;
                R = 0.015;
                g = -9.8;
                J = 9.99e-6;
                H = -m*g/(J/(R^2)+m);
                A = [0 1 0 0; 0 0 H 0; 0 0 0 1; 0 0 0 0];
                B = [0;0;0;1];
                C = [1 0 0 0];
                D = [0];
                K = place(A,B,[-2+2i,-2-2i,-20,-80]);
                N = -inv(C*inv(A-B*K)*B);

                sys = ss(A-B*K,B,C,D);

                t = 0:0.01:5;
                r = ". $r . ";
                initPozicia= " . $startPosition . ";
                initRychlost= " . $startSpeed . ";
                [y,t,x]=lsim(N*sys,r*ones(size(t)),t,[initPozicia;0;initRychlost;0]);
                N*x(:,1)
                x(:,3)
                ";
    }

    public function get_suspension_data(Request $request){

        return '{"position_car":["","0.00000","0.11089","0.25241","0.41524","0.59537","0.78878","0.99146","1.19945","1.40897","1.61639","1.81835","2.01177","2.19388","2.36227","2.51489","2.65010","2.76660","2.86352","2.94035","2.99695","3.03353","3.05064","3.04909","3.02999","2.99466","2.94464","2.88160","2.80737","2.72381","2.63289","2.53655","2.43672","2.33528","2.23404","2.13467","2.03875","1.94770","1.86275","1.78500","1.71533","1.65445","1.60289","1.56097","1.52884","1.50649","1.49372","1.49021","1.49547","1.50892","1.52986","1.55750","1.59101","1.62946","1.67195","1.71751","1.76521","1.81412","1.86335","1.91206","1.95944","2.00479","2.04746","2.08688","2.12257","2.15416","2.18134","2.20391","2.22176","2.23485","2.24325","2.24707","2.24653","2.24187","2.23341","2.22151","2.20658","2.18903","2.16931","2.14788","2.12519","2.10171","2.07786","2.05408","2.03076","2.00826","1.98692","1.96703","1.94884","1.93255","1.91834","1.90632","1.89657","1.88912","1.88396","1.88106","1.88033","1.88165","1.88489","1.88988","1.89644","1.90437","1.91345","1.92347","1.93421","1.94543","1.95693","1.96850","1.97994","1.99105","2.00169","2.01168","2.02091","2.02926","2.03663","2.04298","2.04823","2.05238","2.05541","2.05733","2.05819","2.05801","2.05688","2.05485","2.05203","2.04849","2.04434","2.03968","2.03463","2.02929","2.02377","2.01816","2.01258","2.00710","2.00183","1.99683","1.99217","1.98791","1.98410","1.98079","1.97798","1.97572","1.97399","1.97280","1.97214","1.97199","1.97232","1.97310","1.97429","1.97585","1.97772","1.97987","1.98223","1.98476","1.98740","1.99011","1.99282","1.99551","1.99812","2.00061","2.00295","2.00511","2.00706","2.00879","2.01027","2.01149","2.01245","2.01315","2.01360","2.01379","2.01374","2.01346","2.01297","2.01230","2.01146","2.01048","2.00939","2.00819","2.00694","2.00564","2.00432","2.00301","2.00172","2.00049","1.99931","1.99822","1.99723","1.99634","1.99556","1.99491","1.99438","1.99398","1.99371","1.99356","1.99353","1.99361","1.99380","1.99408","1.99445","1.99489","1.99540","1.99596","1.99655","1.99718","1.99781","1.99845","1.99908","1.99969","2.00028","2.00083","2.00133","2.00179","2.00219","2.00254","2.00282","2.00304","2.00321","2.00331","2.00335","2.00333","2.00327","2.00315","2.00299","2.00279","2.00256","2.00230","2.00202","2.00173","2.00142","2.00111","2.00080","2.00050","2.00021","1.99994","1.99968","1.99945","1.99924","1.99906","1.99891","1.99878","1.99869","1.99863","1.99859","1.99859","1.99861","1.99865","1.99872","1.99881","1.99891","1.99903","1.99916","1.99930","1.99945","1.99960","1.99975","1.99990","2.00004","2.00018","2.00031","2.00043","2.00053","2.00063","2.00071","2.00077","2.00082","2.00086","2.00089","2.00089","2.00089","2.00087","2.00085","2.00081","2.00076","2.00071","2.00065","2.00058","2.00051","2.00044","2.00037","2.00029","2.00022","2.00015","2.00009","2.00003","1.99998","1.99993","1.99988","1.99985","1.99982","1.99980","1.99978","1.99978","1.99978","1.99978","1.99979","1.99981","1.99983","1.99985","1.99988","1.99991","1.99995","1.99998","2.00001","2.00005","2.00008","2.00012","2.00015","2.00018","2.00021","2.00023","2.00025","2.00027","2.00029","2.00030","2.00031","2.00032","2.00032","2.00032","2.00031","2.00031","2.00030","2.00029","2.00027","2.00026","2.00024","2.00023","2.00021","2.00019","2.00017","2.00016","2.00014","2.00013","2.00011","2.00010","2.00009","2.00008","2.00007","2.00006","2.00006","2.00006","2.00005","2.00005","2.00005","2.00006","2.00006","2.00007","2.00007","2.00008","2.00009","2.00009","2.00010","2.00011","2.00012","2.00013","2.00013","2.00014","2.00015","2.00016","2.00016","2.00017","2.00017","2.00017","2.00018","2.00018","2.00018","2.00018","2.00018","2.00018","2.00018","2.00018","2.00017","2.00017","2.00017","2.00016","2.00016","2.00015","2.00015","2.00015","2.00014","2.00014","2.00014","2.00013","2.00013","2.00013","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00013","2.00013","2.00013","2.00013","2.00013","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014"],
                "position_wheel":["","0.000000","-0.060460","-0.071339","-0.080008","-0.086829","-0.091794","-0.094928","-0.096283","-0.095938","-0.093997","-0.090583","-0.085840","-0.079924","-0.073000","-0.065244","-0.056833","-0.047948","-0.038764","-0.029453","-0.020179","-0.011096","-0.002346","0.005944","0.013660","0.020705","0.027000","0.032481","0.037104","0.040840","0.043676","0.045618","0.046683","0.046904","0.046326","0.045005","0.043005","0.040399","0.037266","0.033688","0.029752","0.025544","0.021151","0.016656","0.012142","0.007686","0.003359","-0.000774","-0.004653","-0.008229","-0.011459","-0.014308","-0.016751","-0.018768","-0.020352","-0.021500","-0.022218","-0.022519","-0.022421","-0.021949","-0.021133","-0.020006","-0.018604","-0.016968","-0.015138","-0.013156","-0.011064","-0.008903","-0.006715","-0.004537","-0.002405","-0.000353","0.001589","0.003396","0.005044","0.006516","0.007795","0.008873","0.009741","0.010399","0.010846","0.011087","0.011131","0.010987","0.010669","0.010193","0.009575","0.008834","0.007989","0.007061","0.006069","0.005035","0.003979","0.002918","0.001872","0.000857","-0.000112","-0.001021","-0.001858","-0.002613","-0.003279","-0.003848","-0.004318","-0.004686","-0.004951","-0.005116","-0.005182","-0.005155","-0.005041","-0.004846","-0.004578","-0.004246","-0.003859","-0.003427","-0.002960","-0.002468","-0.001960","-0.001445","-0.000934","-0.000434","0.000048","0.000503","0.000926","0.001311","0.001655","0.001954","0.002205","0.002407","0.002559","0.002662","0.002717","0.002725","0.002689","0.002613","0.002500","0.002353","0.002178","0.001978","0.001759","0.001526","0.001282","0.001034","0.000785","0.000539","0.000301","0.000074","-0.000139","-0.000335","-0.000512","-0.000667","-0.000800","-0.000909","-0.000995","-0.001056","-0.001094","-0.001108","-0.001101","-0.001073","-0.001027","-0.000963","-0.000885","-0.000793","-0.000691","-0.000581","-0.000465","-0.000346","-0.000225","-0.000105","0.000012","0.000125","0.000232","0.000331","0.000421","0.000502","0.000571","0.000630","0.000677","0.000712","0.000736","0.000748","0.000749","0.000741","0.000722","0.000695","0.000660","0.000619","0.000572","0.000520","0.000465","0.000408","0.000349","0.000291","0.000233","0.000177","0.000124","0.000074","0.000028","-0.000013","-0.000049","-0.000080","-0.000106","-0.000126","-0.000140","-0.000149","-0.000152","-0.000150","-0.000143","-0.000132","-0.000117","-0.000098","-0.000077","-0.000053","-0.000027","0.000000","0.000029","0.000057","0.000085","0.000113","0.000139","0.000164","0.000187","0.000208","0.000227","0.000243","0.000257","0.000268","0.000276","0.000281","0.000284","0.000284","0.000282","0.000278","0.000271","0.000263","0.000253","0.000242","0.000230","0.000217","0.000203","0.000190","0.000176","0.000162","0.000149","0.000137","0.000125","0.000114","0.000105","0.000096","0.000089","0.000083","0.000078","0.000075","0.000073","0.000072","0.000073","0.000074","0.000077","0.000081","0.000085","0.000090","0.000096","0.000102","0.000108","0.000115","0.000121","0.000128","0.000134","0.000141","0.000146","0.000152","0.000157","0.000161","0.000165","0.000168","0.000171","0.000172","0.000174","0.000174","0.000174","0.000174","0.000173","0.000171","0.000169","0.000167","0.000164","0.000161","0.000158","0.000155","0.000152","0.000148","0.000145","0.000142","0.000139","0.000136","0.000134","0.000132","0.000130","0.000128","0.000127","0.000125","0.000125","0.000124","0.000124","0.000124","0.000124","0.000125","0.000126","0.000127","0.000128","0.000129","0.000131","0.000132","0.000134","0.000135","0.000137","0.000138","0.000140","0.000141","0.000142","0.000144","0.000145","0.000145","0.000146","0.000147","0.000147","0.000147","0.000148","0.000148","0.000147","0.000147","0.000147","0.000146","0.000146","0.000145","0.000144","0.000144","0.000143","0.000142","0.000141","0.000141","0.000140","0.000139","0.000138","0.000138","0.000137","0.000137","0.000136","0.000136","0.000136","0.000136","0.000135","0.000135","0.000135","0.000135","0.000136","0.000136","0.000136","0.000136","0.000137","0.000137","0.000137","0.000138","0.000138","0.000138","0.000139","0.000139","0.000139","0.000139","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000139","0.000139","0.000139","0.000139","0.000139","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136"],
                "time":["","0.00000","0.01000","0.02000","0.03000","0.04000","0.05000","0.06000","0.07000","0.08000","0.09000","0.10000","0.11000","0.12000","0.13000","0.14000","0.15000","0.16000","0.17000","0.18000","0.19000","0.20000","0.21000","0.22000","0.23000","0.24000","0.25000","0.26000","0.27000","0.28000","0.29000","0.30000","0.31000","0.32000","0.33000","0.34000","0.35000","0.36000","0.37000","0.38000","0.39000","0.40000","0.41000","0.42000","0.43000","0.44000","0.45000","0.46000","0.47000","0.48000","0.49000","0.50000","0.51000","0.52000","0.53000","0.54000","0.55000","0.56000","0.57000","0.58000","0.59000","0.60000","0.61000","0.62000","0.63000","0.64000","0.65000","0.66000","0.67000","0.68000","0.69000","0.70000","0.71000","0.72000","0.73000","0.74000","0.75000","0.76000","0.77000","0.78000","0.79000","0.80000","0.81000","0.82000","0.83000","0.84000","0.85000","0.86000","0.87000","0.88000","0.89000","0.90000","0.91000","0.92000","0.93000","0.94000","0.95000","0.96000","0.97000","0.98000","0.99000","1.00000","1.01000","1.02000","1.03000","1.04000","1.05000","1.06000","1.07000","1.08000","1.09000","1.10000","1.11000","1.12000","1.13000","1.14000","1.15000","1.16000","1.17000","1.18000","1.19000","1.20000","1.21000","1.22000","1.23000","1.24000","1.25000","1.26000","1.27000","1.28000","1.29000","1.30000","1.31000","1.32000","1.33000","1.34000","1.35000","1.36000","1.37000","1.38000","1.39000","1.40000","1.41000","1.42000","1.43000","1.44000","1.45000","1.46000","1.47000","1.48000","1.49000","1.50000","1.51000","1.52000","1.53000","1.54000","1.55000","1.56000","1.57000","1.58000","1.59000","1.60000","1.61000","1.62000","1.63000","1.64000","1.65000","1.66000","1.67000","1.68000","1.69000","1.70000","1.71000","1.72000","1.73000","1.74000","1.75000","1.76000","1.77000","1.78000","1.79000","1.80000","1.81000","1.82000","1.83000","1.84000","1.85000","1.86000","1.87000","1.88000","1.89000","1.90000","1.91000","1.92000","1.93000","1.94000","1.95000","1.96000","1.97000","1.98000","1.99000","2.00000","2.01000","2.02000","2.03000","2.04000","2.05000","2.06000","2.07000","2.08000","2.09000","2.10000","2.11000","2.12000","2.13000","2.14000","2.15000","2.16000","2.17000","2.18000","2.19000","2.20000","2.21000","2.22000","2.23000","2.24000","2.25000","2.26000","2.27000","2.28000","2.29000","2.30000","2.31000","2.32000","2.33000","2.34000","2.35000","2.36000","2.37000","2.38000","2.39000","2.40000","2.41000","2.42000","2.43000","2.44000","2.45000","2.46000","2.47000","2.48000","2.49000","2.50000","2.51000","2.52000","2.53000","2.54000","2.55000","2.56000","2.57000","2.58000","2.59000","2.60000","2.61000","2.62000","2.63000","2.64000","2.65000","2.66000","2.67000","2.68000","2.69000","2.70000","2.71000","2.72000","2.73000","2.74000","2.75000","2.76000","2.77000","2.78000","2.79000","2.80000","2.81000","2.82000","2.83000","2.84000","2.85000","2.86000","2.87000","2.88000","2.89000","2.90000","2.91000","2.92000","2.93000","2.94000","2.95000","2.96000","2.97000","2.98000","2.99000","3.00000","3.01000","3.02000","3.03000","3.04000","3.05000","3.06000","3.07000","3.08000","3.09000","3.10000","3.11000","3.12000","3.13000","3.14000","3.15000","3.16000","3.17000","3.18000","3.19000","3.20000","3.21000","3.22000","3.23000","3.24000","3.25000","3.26000","3.27000","3.28000","3.29000","3.30000","3.31000","3.32000","3.33000","3.34000","3.35000","3.36000","3.37000","3.38000","3.39000","3.40000","3.41000","3.42000","3.43000","3.44000","3.45000","3.46000","3.47000","3.48000","3.49000","3.50000","3.51000","3.52000","3.53000","3.54000","3.55000","3.56000","3.57000","3.58000","3.59000","3.60000","3.61000","3.62000","3.63000","3.64000","3.65000","3.66000","3.67000","3.68000","3.69000","3.70000","3.71000","3.72000","3.73000","3.74000","3.75000","3.76000","3.77000","3.78000","3.79000","3.80000","3.81000","3.82000","3.83000","3.84000","3.85000","3.86000","3.87000","3.88000","3.89000","3.90000","3.91000","3.92000","3.93000","3.94000","3.95000","3.96000","3.97000","3.98000","3.99000","4.00000","4.01000","4.02000","4.03000","4.04000","4.05000","4.06000","4.07000","4.08000","4.09000","4.10000","4.11000","4.12000","4.13000","4.14000","4.15000","4.16000","4.17000","4.18000","4.19000","4.20000","4.21000","4.22000","4.23000","4.24000","4.25000","4.26000","4.27000","4.28000","4.29000","4.30000","4.31000","4.32000","4.33000","4.34000","4.35000","4.36000","4.37000","4.38000","4.39000","4.40000","4.41000","4.42000","4.43000","4.44000","4.45000","4.46000","4.47000","4.48000","4.49000","4.50000","4.51000","4.52000","4.53000","4.54000","4.55000","4.56000","4.57000","4.58000","4.59000","4.60000","4.61000","4.62000","4.63000","4.64000","4.65000","4.66000","4.67000","4.68000","4.69000","4.70000","4.71000","4.72000","4.73000","4.74000","4.75000","4.76000","4.77000","4.78000","4.79000","4.80000","4.81000","4.82000","4.83000","4.84000","4.85000","4.86000","4.87000","4.88000","4.89000","4.90000","4.91000","4.92000","4.93000","4.94000","4.95000","4.96000","4.97000","4.98000","4.99000","5.00000"]}';
        try {

            $query = ($request->query());

            $r = $query["r"];

            $command = $this->get_suspension_script($r,0,0);

            $logCommand = $command;
            $log = new LogRequest($logCommand, "OK");
            $log->save();

            $response = trim(shell_exec('octave --no-gui --quiet --eval "pkg load control;'. $command .'"'));


            $parsed = explode("ans =",$response);

            $positionCar = explode('  ',$parsed[1]);
            $positionWheel = explode('  ',$parsed[2]);
            $time = explode('  ',$parsed[3]);

            $positionCar = array_map('trim', $positionCar);
            $positionWheel = array_map('trim',$positionWheel);
            $time = array_map('trim',$time);

            $return = array(
                "position_car" => $positionCar,
                "position_wheel" => $positionWheel,
                "time" => $time
            );

            return json_encode($return);
            } catch (\Throwable $th) {
                //throw $th;
                $log = new LogRequest($logCommand, "Error", "500 Internal Server Error");
                $log->save();

                return response("Error",500);
            }

    }

    public function get_suspension_script($r, $startX1, $startX2){
        return "m1 = 2500; m2 = 320;
        k1 = 80000; k2 = 500000;
        b1 = 350; b2 = 15020;
        A=[0 1 0 0;-(b1*b2)/(m1*m2) 0 ((b1/m1)*((b1/m1)+(b1/m2)+(b2/m2)))-(k1/m1) -(b1/m1);b2/m2 0 -((b1/m1)+(b1/m2)+(b2/m2)) 1;k2/m2 0 -((k1/m1)+(k1/m2)+(k2/m2)) 0];
        B=[0 0;1/m1 (b1*b2)/(m1*m2);0 -(b2/m2);(1/m1)+(1/m2) -(k2/m2)];
        C=[0 0 1 0]; D=[0 0];
        Aa = [[A,[0 0 0 0]'];[C, 0]];
        Ba = [B;[0 0]];
        Ca = [C,0]; Da = D;
        K = [0 2.3e6 5e8 0 8e6];
        sys = ss(Aa-Ba(:,1)*K,Ba,Ca,Da);

        t = 0:0.01:5;
        r =".$r.";
        initX1=0;
        initX1d=0;
        initX2=0;
        initX2d=0;
        [y,t,x]=lsim(sys*[0;1],r*ones(size(t)),t,[initX1;initX1d;initX2;initX2d;0]);
        x(:,1)
        x(:,3)
        t(:)
        ";
    }


}
