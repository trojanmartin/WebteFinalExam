<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Http\File;
use Illuminate\Support\Facades\Input;

class OctaveController extends Controller
{
    public function index()
    {
       // $response = shell_exec("octave --no-gui --quiet ../../kyvadlo.txt {r}");

        $command = Storage::get('octave/gulicka.txt');

        $response = ltrim(shell_exec('octave --no-gui --quiet --eval "pkg load control;'. $command .'"'));

        return response($response,200);
    }

    public function execute_octave_command(Request $request)
    {
       $data = $request->json()->all();

       $command = $data["command"];

       $result = ltrim(shell_exec('octave --no-gui --quiet --eval "'. $command .'"'));

       $response = array(
           "result" => $result
       );

       return json_encode($response);
    }


    public function get_ball_data(Request $request)
    {

        try {

        $query = ($request->query());

        $r = $query["r"];
        $startPosition = $query["startPosition"];
        $startSpeed = $query["startSpeed"];

        $command = $this->get_ball_script($r,$startPosition,$startSpeed);

        $response = trim(shell_exec('octave --no-gui --quiet --eval "pkg load control;'. $command .'"'));


        $parsed = explode("ans =",$response);

        $position = explode('  ',$parsed[1]);
        $alfa = explode('  ',$parsed[2]);

	$position = array_map('trim', $position);
	$alfa = array_map('trim',$alfa);

        $return = array(
            "position" => $position,
            "angle" => $alfa
        );

        return json_encode($return);
        } catch (\Throwable $th) {
//throw $th;
  	 return response("Error",500);
        }


    }



    private function get_ball_script($r,$startPosition,$startSpeed)
    {
        return "
                m = 0.111;
                R = 0.015;
                g = -9.8;
                J = 9.99e-6;
                H = -m*g/(J/(R^2)+m);
                A = [0 1 0 0; 0 0 H 0; 0 0 0 1; 0 0 0 0];
                B = [0;0;0;1];
                C = [1 0 0 0];
                D = [0];
                K = place(A,B,[-2+2i,-2-2i,-20,-80]);
                N = -inv(C*inv(A-B*K)*B);

                sys = ss(A-B*K,B,C,D);

                t = 0:0.01:5;
                r = ". $r . ";
                initPozicia= " . $startPosition . ";
                initRychlost= " . $startSpeed . ";
                [y,t,x]=lsim(N*sys,r*ones(size(t)),t,[initPozicia;0;initRychlost;0]);
                N*x(:,1)
                x(:,3)
                ";
    }

    public function get_suspension_data(Request $request){
        return '{"position_car":["","0.00000","0.11089","0.25241","0.41524","0.59537","0.78878","0.99146","1.19945","1.40897","1.61639","1.81835","2.01177","2.19388","2.36227","2.51489","2.65010","2.76660","2.86352","2.94035","2.99695","3.03353","3.05064","3.04909","3.02999","2.99466","2.94464","2.88160","2.80737","2.72381","2.63289","2.53655","2.43672","2.33528","2.23404","2.13467","2.03875","1.94770","1.86275","1.78500","1.71533","1.65445","1.60289","1.56097","1.52884","1.50649","1.49372","1.49021","1.49547","1.50892","1.52986","1.55750","1.59101","1.62946","1.67195","1.71751","1.76521","1.81412","1.86335","1.91206","1.95944","2.00479","2.04746","2.08688","2.12257","2.15416","2.18134","2.20391","2.22176","2.23485","2.24325","2.24707","2.24653","2.24187","2.23341","2.22151","2.20658","2.18903","2.16931","2.14788","2.12519","2.10171","2.07786","2.05408","2.03076","2.00826","1.98692","1.96703","1.94884","1.93255","1.91834","1.90632","1.89657","1.88912","1.88396","1.88106","1.88033","1.88165","1.88489","1.88988","1.89644","1.90437","1.91345","1.92347","1.93421","1.94543","1.95693","1.96850","1.97994","1.99105","2.00169","2.01168","2.02091","2.02926","2.03663","2.04298","2.04823","2.05238","2.05541","2.05733","2.05819","2.05801","2.05688","2.05485","2.05203","2.04849","2.04434","2.03968","2.03463","2.02929","2.02377","2.01816","2.01258","2.00710","2.00183","1.99683","1.99217","1.98791","1.98410","1.98079","1.97798","1.97572","1.97399","1.97280","1.97214","1.97199","1.97232","1.97310","1.97429","1.97585","1.97772","1.97987","1.98223","1.98476","1.98740","1.99011","1.99282","1.99551","1.99812","2.00061","2.00295","2.00511","2.00706","2.00879","2.01027","2.01149","2.01245","2.01315","2.01360","2.01379","2.01374","2.01346","2.01297","2.01230","2.01146","2.01048","2.00939","2.00819","2.00694","2.00564","2.00432","2.00301","2.00172","2.00049","1.99931","1.99822","1.99723","1.99634","1.99556","1.99491","1.99438","1.99398","1.99371","1.99356","1.99353","1.99361","1.99380","1.99408","1.99445","1.99489","1.99540","1.99596","1.99655","1.99718","1.99781","1.99845","1.99908","1.99969","2.00028","2.00083","2.00133","2.00179","2.00219","2.00254","2.00282","2.00304","2.00321","2.00331","2.00335","2.00333","2.00327","2.00315","2.00299","2.00279","2.00256","2.00230","2.00202","2.00173","2.00142","2.00111","2.00080","2.00050","2.00021","1.99994","1.99968","1.99945","1.99924","1.99906","1.99891","1.99878","1.99869","1.99863","1.99859","1.99859","1.99861","1.99865","1.99872","1.99881","1.99891","1.99903","1.99916","1.99930","1.99945","1.99960","1.99975","1.99990","2.00004","2.00018","2.00031","2.00043","2.00053","2.00063","2.00071","2.00077","2.00082","2.00086","2.00089","2.00089","2.00089","2.00087","2.00085","2.00081","2.00076","2.00071","2.00065","2.00058","2.00051","2.00044","2.00037","2.00029","2.00022","2.00015","2.00009","2.00003","1.99998","1.99993","1.99988","1.99985","1.99982","1.99980","1.99978","1.99978","1.99978","1.99978","1.99979","1.99981","1.99983","1.99985","1.99988","1.99991","1.99995","1.99998","2.00001","2.00005","2.00008","2.00012","2.00015","2.00018","2.00021","2.00023","2.00025","2.00027","2.00029","2.00030","2.00031","2.00032","2.00032","2.00032","2.00031","2.00031","2.00030","2.00029","2.00027","2.00026","2.00024","2.00023","2.00021","2.00019","2.00017","2.00016","2.00014","2.00013","2.00011","2.00010","2.00009","2.00008","2.00007","2.00006","2.00006","2.00006","2.00005","2.00005","2.00005","2.00006","2.00006","2.00007","2.00007","2.00008","2.00009","2.00009","2.00010","2.00011","2.00012","2.00013","2.00013","2.00014","2.00015","2.00016","2.00016","2.00017","2.00017","2.00017","2.00018","2.00018","2.00018","2.00018","2.00018","2.00018","2.00018","2.00018","2.00017","2.00017","2.00017","2.00016","2.00016","2.00015","2.00015","2.00015","2.00014","2.00014","2.00014","2.00013","2.00013","2.00013","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00012","2.00013","2.00013","2.00013","2.00013","2.00013","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00015","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00013","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014","2.00014"],
                "position_wheel":["","0.000000","-0.060460","-0.071339","-0.080008","-0.086829","-0.091794","-0.094928","-0.096283","-0.095938","-0.093997","-0.090583","-0.085840","-0.079924","-0.073000","-0.065244","-0.056833","-0.047948","-0.038764","-0.029453","-0.020179","-0.011096","-0.002346","0.005944","0.013660","0.020705","0.027000","0.032481","0.037104","0.040840","0.043676","0.045618","0.046683","0.046904","0.046326","0.045005","0.043005","0.040399","0.037266","0.033688","0.029752","0.025544","0.021151","0.016656","0.012142","0.007686","0.003359","-0.000774","-0.004653","-0.008229","-0.011459","-0.014308","-0.016751","-0.018768","-0.020352","-0.021500","-0.022218","-0.022519","-0.022421","-0.021949","-0.021133","-0.020006","-0.018604","-0.016968","-0.015138","-0.013156","-0.011064","-0.008903","-0.006715","-0.004537","-0.002405","-0.000353","0.001589","0.003396","0.005044","0.006516","0.007795","0.008873","0.009741","0.010399","0.010846","0.011087","0.011131","0.010987","0.010669","0.010193","0.009575","0.008834","0.007989","0.007061","0.006069","0.005035","0.003979","0.002918","0.001872","0.000857","-0.000112","-0.001021","-0.001858","-0.002613","-0.003279","-0.003848","-0.004318","-0.004686","-0.004951","-0.005116","-0.005182","-0.005155","-0.005041","-0.004846","-0.004578","-0.004246","-0.003859","-0.003427","-0.002960","-0.002468","-0.001960","-0.001445","-0.000934","-0.000434","0.000048","0.000503","0.000926","0.001311","0.001655","0.001954","0.002205","0.002407","0.002559","0.002662","0.002717","0.002725","0.002689","0.002613","0.002500","0.002353","0.002178","0.001978","0.001759","0.001526","0.001282","0.001034","0.000785","0.000539","0.000301","0.000074","-0.000139","-0.000335","-0.000512","-0.000667","-0.000800","-0.000909","-0.000995","-0.001056","-0.001094","-0.001108","-0.001101","-0.001073","-0.001027","-0.000963","-0.000885","-0.000793","-0.000691","-0.000581","-0.000465","-0.000346","-0.000225","-0.000105","0.000012","0.000125","0.000232","0.000331","0.000421","0.000502","0.000571","0.000630","0.000677","0.000712","0.000736","0.000748","0.000749","0.000741","0.000722","0.000695","0.000660","0.000619","0.000572","0.000520","0.000465","0.000408","0.000349","0.000291","0.000233","0.000177","0.000124","0.000074","0.000028","-0.000013","-0.000049","-0.000080","-0.000106","-0.000126","-0.000140","-0.000149","-0.000152","-0.000150","-0.000143","-0.000132","-0.000117","-0.000098","-0.000077","-0.000053","-0.000027","0.000000","0.000029","0.000057","0.000085","0.000113","0.000139","0.000164","0.000187","0.000208","0.000227","0.000243","0.000257","0.000268","0.000276","0.000281","0.000284","0.000284","0.000282","0.000278","0.000271","0.000263","0.000253","0.000242","0.000230","0.000217","0.000203","0.000190","0.000176","0.000162","0.000149","0.000137","0.000125","0.000114","0.000105","0.000096","0.000089","0.000083","0.000078","0.000075","0.000073","0.000072","0.000073","0.000074","0.000077","0.000081","0.000085","0.000090","0.000096","0.000102","0.000108","0.000115","0.000121","0.000128","0.000134","0.000141","0.000146","0.000152","0.000157","0.000161","0.000165","0.000168","0.000171","0.000172","0.000174","0.000174","0.000174","0.000174","0.000173","0.000171","0.000169","0.000167","0.000164","0.000161","0.000158","0.000155","0.000152","0.000148","0.000145","0.000142","0.000139","0.000136","0.000134","0.000132","0.000130","0.000128","0.000127","0.000125","0.000125","0.000124","0.000124","0.000124","0.000124","0.000125","0.000126","0.000127","0.000128","0.000129","0.000131","0.000132","0.000134","0.000135","0.000137","0.000138","0.000140","0.000141","0.000142","0.000144","0.000145","0.000145","0.000146","0.000147","0.000147","0.000147","0.000148","0.000148","0.000147","0.000147","0.000147","0.000146","0.000146","0.000145","0.000144","0.000144","0.000143","0.000142","0.000141","0.000141","0.000140","0.000139","0.000138","0.000138","0.000137","0.000137","0.000136","0.000136","0.000136","0.000136","0.000135","0.000135","0.000135","0.000135","0.000136","0.000136","0.000136","0.000136","0.000137","0.000137","0.000137","0.000138","0.000138","0.000138","0.000139","0.000139","0.000139","0.000139","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000140","0.000139","0.000139","0.000139","0.000139","0.000139","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000138","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000137","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136","0.000136"]}';

        try {

            $query = ($request->query());

            $r = $query["r"];
            //$startCar = $query["startCar"];
            //$startWheel = $query["startWheel"];

            $command = $this->get_suspension_script($r,0,0);

            $response = trim(shell_exec('octave --no-gui --quiet --eval "pkg load control;'. $command .'"'));


            $parsed = explode("ans =",$response);

            $positionCar = explode('  ',$parsed[1]);
            $positionWheel = explode('  ',$parsed[2]);
            $time = explode('  ',$parsed[3]);

            $positionCar = array_map('trim', $positionCar);
            $positionWheel = array_map('trim',$positionWheel);
            $time = array_map('trim',$time);

            $return = array(
                "position_car" => $positionCar,
                "position_wheel" => $positionWheel,
                "time" => $time
            );

            return json_encode($return);
            } catch (\Throwable $th) {
                //throw $th;
                return response("Error",500);
            }

    }

    public function get_suspension_script($r, $startX1, $startX2){
        return "m1 = 2500; m2 = 320;
        k1 = 80000; k2 = 500000;
        b1 = 350; b2 = 15020;
        A=[0 1 0 0;-(b1*b2)/(m1*m2) 0 ((b1/m1)*((b1/m1)+(b1/m2)+(b2/m2)))-(k1/m1) -(b1/m1);b2/m2 0 -((b1/m1)+(b1/m2)+(b2/m2)) 1;k2/m2 0 -((k1/m1)+(k1/m2)+(k2/m2)) 0];
        B=[0 0;1/m1 (b1*b2)/(m1*m2);0 -(b2/m2);(1/m1)+(1/m2) -(k2/m2)];
        C=[0 0 1 0]; D=[0 0];
        Aa = [[A,[0 0 0 0]'];[C, 0]];
        Ba = [B;[0 0]];
        Ca = [C,0]; Da = D;
        K = [0 2.3e6 5e8 0 8e6];
        sys = ss(Aa-Ba(:,1)*K,Ba,Ca,Da);

        t = 0:0.01:5;
        r =".$r.";
        initX1=0;
        initX1d=0;
        initX2=0;
        initX2d=0;
        [y,t,x]=lsim(sys*[0;1],r*ones(size(t)),t,[initX1;initX1d;initX2;initX2d;0]);
        x(:,1)
        x(:,3)
        t(:)
        ";
    }


}
